<?php

/**
 * @file
 */

/**
 * Implements hook_page_alter().
 *
 * Add channel management forms to unit availability management page.
 */
function rooms_channel_manager_page_alter(&$page) {
  $forms = array();
  if (isset($page['content']['system_main']['#theme']) &&
     ($page['content']['system_main']['#theme'] == 'rooms_three_month_calendar') &&
     ($page['content']['system_main']['#form']['#form_id'] == 'update_availability_calendar_form')) {

    // If this is a rooms unit, load unit source forms.
    if ($unit = menu_get_object('rooms_unit', 4)) {

      // Get enabled availability sources.
      foreach (module_invoke_all('rooms_channel_source') as $source) {
        $importer = new $source['handler']['class'];
        $importer->config->unit_id = $unit->unit_id;
        $importer->load();

        $form = $importer->config_form();
        $form['class'] = array(
          '#type' => 'hidden',
          '#value' => $source['handler']['class'],
        );
        $form_id = $source['handler']['class'] . '_config_form';
        $form_state = form_state_defaults();
        if (!isset($form_state['input'])) {
          $form_state['input'] = $form_state['method'] == 'get' ? $_GET : $_POST;
        }
        $form_state['validate_handlers'] = array('rooms_channel_manager_config_form_validate');
        $form_state['submit_handlers'] = array('rooms_channel_manager_config_form_submit');
        drupal_prepare_form($form_id, $form, $form_state);
        drupal_process_form($form_id, $form, $form_state);
        $forms[] = $form;
      }
    }

    $page['content']['system_main']['#form'] += $forms;
  }

}

/**
 * Wrapper function - execute validation handler for configuration form.
 */
function rooms_channel_manager_config_form_validate($form, &$form_state) {
  $importer = new $form['class']['#value'];
  if (method_exists($importer, 'config_form_validate')) {
    $importer->config_form_validate($form, $form_state);
  }
}

/**
 * Wrapper function - execute submission handler for configuration form.
 */
function rooms_channel_manager_config_form_submit($form, &$form_state) {
  $importer = new $form['class']['#value'];
  if (method_exists($importer, 'config_form_submit')) {
    $importer->config_form_submit($form, $form_state);
  }
}

/**
 * Implements hook_cron()
 */
function rooms_channel_manager_cron() {
  $queue = DrupalQueue::get('rooms_channel_manager');
  foreach (module_invoke_all('rooms_channel_source') as $source) {
    $result = db_query("SELECT unit_id FROM {rooms_channel_manager_sources} WHERE module = :module", array(':module' => $source['handler']['module']));
    foreach ($result as $record) {
      $queue->createItem(array('unit_id' => $record->unit_id, 'class' => $source['handler']['class']));
    }
  }
}

/**
 * Implements hook_cron_queue_info()
 */
function rooms_channel_manager_cron_queue_info() {
  $queues['rooms_channel_manager'] = array(
    'worker callback' => 'rooms_channel_manager_update_availability',
    'time' => 60,
  );
  return $queues;
}

/**
 * Cron queue callback - update availability from remote source.
 */
function rooms_channel_manager_update_availability($data) {
  if (isset($data['class'])) {
    $importer = new $data['class'];
    $importer->config->unit_id = $data['unit_id'];
    $importer->load();
    if ($importer->updateNeeded()) {
      $importer->importBookingsFromSource();
    }
  }
}
